# docker-paf-admin

## Deployment

The app is deployed on Upcloud to a Kubernetes cluster. The deploy process is automated with GitHub workflows.

## Local validation

However, it is possible to validate the build process locally using Docker.

```bash
docker build -t paf-admin-app .
```
This statically compiles the client javascript and installs all server dependencies.

### Testing in Linux

On linux-docker, the special docker network `host` allows sharing the host network. That allows running a simple mysql image within Docker, provided in the `sql-init` folder:

```bash
cd sql-init/
docker build -t paf-sql .
docker run --network host -p 3306:3306 -e MYSQL_RANDOM_ROOT_PASSWORD=True -t paf-sql
```

This will generate a random MySQL password.

You can store that in a `.env` file for the `paf-admin-app` to read:

```bash
HOST=localhost
PORT=8000

# This defines a "salt" used by the Argon2 password hasher
APP_KEY=abcdefg1234567890
SESSION_DRIVER=cookie

DB_CONNECTION=mysql

MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_DB_NAME=paf-admin
MYSQL_USER=root
# Use the root password generated by mysql, above
MYSQL_PASSWORD=abcdefg1234567890
```

To generate an admin user, you can manually add a database entry (based on the APP_KEY above as salt). Hash a password [here](https://argon2.online/) with memory cost of 1024.

Then, connect to the mysql database through docker using the :

```bash
docker exec -it <container-id> mysql -uroot -p
```

Enter the mysql password.

```sql
use paf-admin;

INSERT INTO `users` (`id`, `user`, `role`, `password`) VALUES (1, 'admin', 'admin', '$argon2-hashed-password');
```


Run the app container:

```bash
docker run -p 8000:8000 --network host --env-file .env -it paf-admin-app
```

Then, at http://localhost:8000, you can sign in with the admin user and the password you created!